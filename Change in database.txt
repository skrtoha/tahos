CREATE TABLE `tahos_email_prices` (
  `store_id` int(10) UNSIGNED NOT NULL,
  `settings` json NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
ALTER TABLE `tahos_email_prices`
  ADD PRIMARY KEY (`store_id`);
COMMIT;

ALTER TABLE `tahos_order_issue_values` ADD `store_id` INT(10) UNSIGNED NOT NULL AFTER `order_id`;
ALTER TABLE `tahos`.`tahos_order_issue_values` DROP PRIMARY KEY, ADD PRIMARY KEY (`issue_id`, `order_id`, `store_id`, `item_id`) USING BTREE;

CREATE TABLE `tahos_provider_brends` (
  `brend_id` int(10) UNSIGNED NOT NULL,
  `provider_id` int(10) UNSIGNED NOT NULL,
  `title` varchar(255) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

ALTER TABLE `tahos_provider_brends`
  ADD PRIMARY KEY (`brend_id`,`provider_id`),
  ADD KEY `provider_id` (`provider_id`);
  ALTER TABLE `tahos_provider_brends`
  ADD CONSTRAINT `tahos_provider_brends_ibfk_1` FOREIGN KEY (`brend_id`) REFERENCES `tahos_brends` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  ADD CONSTRAINT `tahos_provider_brends_ibfk_2` FOREIGN KEY (`provider_id`) REFERENCES `tahos_providers` (`id`) ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE `tahos_providers` ADD `is_disabled` TINYINT(1) UNSIGNED NOT NULL DEFAULT '0' AFTER `fact_adres`

ALTER TABLE `tahos_items` ADD `is_blocked` TINYINT(1) UNSIGNED NOT NULL DEFAULT '0' AFTER `updated`;

ALTER TABLE `tahos_users` ADD `allow_request_delete_item` INT(1) UNSIGNED NOT NULL DEFAULT '0' AFTER `isAutomaticOrder`;
CREATE TABLE `tahos`.`tahos_user_request_delete_item` ( `user_id` INT(10) UNSIGNED NOT NULL , `item_id` INT(10) UNSIGNED NOT NULL ) ENGINE = InnoDB;
ALTER TABLE `tahos_user_request_delete_item` ADD PRIMARY KEY( `user_id`, `item_id`);
ALTER TABLE `tahos_user_request_delete_item` ADD `created` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP AFTER `item_id`;
ALTER TABLE `tahos_user_request_delete_item` ADD `is_processed` INT(1) NOT NULL DEFAULT '0' AFTER `item_id`;

ALTER TABLE `tahos_providers` CHANGE `is_disabled` `is_disabled_api_search` TINYINT(1) UNSIGNED NOT NULL DEFAULT '0';
ALTER TABLE `tahos_providers` ADD `is_disabled_api_order` TINYINT(1) UNSIGNED NOT NULL DEFAULT '0' AFTER `is_disabled_api_search`;
ALTER TABLE `tahos_providers` ADD `api_title` VARCHAR(255) NULL DEFAULT NULL AFTER `fact_adres`;

UPDATE `tahos_providers` SET `api_title` = 'Armtek' WHERE `tahos_providers`.`id` = 2;
UPDATE `tahos_providers` SET `api_title` = 'FavoriteParts' WHERE `tahos_providers`.`id` = 19;
UPDATE `tahos_providers` SET `api_title` = 'Mikado' WHERE `tahos_providers`.`id` = 8;
UPDATE `tahos_providers` SET `api_title` = 'Abcp' WHERE `tahos_providers`.`id` = 6;
UPDATE `tahos_providers` SET `api_title` = 'Abcp' WHERE `tahos_providers`.`id` = 13;
UPDATE `tahos_providers` SET `api_title` = 'Rossko' WHERE `tahos_providers`.`id` = 15;

ALTER TABLE `tahos_settings` CHANGE `id` `id` INT(1) NOT NULL AUTO_INCREMENT, CHANGE `ratings` `ratings` VARCHAR(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL, CHANGE `cat_perPage` `cat_perPage` INT(2) NOT NULL DEFAULT '30', CHANGE `cat_countChunk` `cat_countChunk` INT(2) NOT NULL DEFAULT '10', CHANGE `news_perPage` `news_perPage` INT(3) NOT NULL DEFAULT '10', CHANGE `news_linksLimit` `news_linksLimit` INT(3) NOT NULL DEFAULT '10', CHANGE `currencies_update` `currencies_update` INT(10) NULL DEFAULT NULL, CHANGE `help_main` `help_main` TEXT CHARACTER SET utf8 COLLATE utf8_general_ci NULL, CHANGE `agreement` `agreement` TEXT CHARACTER SET utf8 COLLATE utf8_general_ci NULL, CHANGE `discount` `discount` DOUBLE NULL DEFAULT '0', CHANGE `for_providers` `for_providers` TEXT CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL, CHANGE `for_wholesellers` `for_wholesellers` TEXT CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL, CHANGE `about_company` `about_company` TEXT CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL, CHANGE `partner_programs` `partner_programs` TEXT CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL, CHANGE `bonus_size` `bonus_size` FLOAT NULL DEFAULT NULL, CHANGE `days_for_return` `days_for_return` INT(2) NOT NULL DEFAULT '14' COMMENT 'количество дней на возврат товара', CHANGE `countItems` `countItems` INT(10) UNSIGNED NOT NULL DEFAULT '0';
INSERT INTO `tahos_settings` (`id`, `ratings`, `cat_perPage`, `cat_countChunk`, `news_perPage`, `news_linksLimit`, `currencies_update`, `help_main`, `agreement`, `discount`, `for_providers`, `for_wholesellers`, `about_company`, `partner_programs`, `bonus_size`, `days_for_return`, `countItems`) VALUES (NULL, NULL, '30', '10', '10', '10', NULL, NULL, NULL, '0', '', '', '', '', NULL, '14', '0');

ALTER TABLE `tahos_items` CHANGE `isBlocked` `is_blocked` TINYINT(1) UNSIGNED NOT NULL DEFAULT '0';

ALTER TABLE `tahos_funds` CHANGE `sum` `sum` INT(7) NULL DEFAULT NULL;

ALTER TABLE `tahos_providers` CHANGE `is_disabled_api_search` `is_enabled_api_search` TINYINT(1) UNSIGNED NOT NULL DEFAULT '0', CHANGE `is_disabled_api_order` `is_enabled_api_order` TINYINT(1) UNSIGNED NOT NULL DEFAULT '0';

CREATE TABLE `tahos_logs` (
  `id` int(10) UNSIGNED NOT NULL,
  `url` varchar(255) DEFAULT NULL,
  `query` text,
  `text` text NOT NULL,
  `trace` text,
  `created` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
ALTER TABLE `tahos_logs`
  ADD PRIMARY KEY (`id`);
ALTER TABLE `tahos_logs`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT;

ALTER TABLE `tahos_mikado_zakazcode` ADD INDEX(`ZakazCode`);

CREATE TRIGGER `decreaseCountItems` AFTER DELETE ON `tahos_items` FOR EACH ROW BEGIN UPDATE tahos_settings SET countItems = countItems - 1 WHERE id=1; END

ALTER TABLE `tahos_analogies` ADD `created` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP AFTER `hidden`;

----tahos_provider_basket start


CREATE TABLE `tahos_provider_basket` (
  `order_id` int(10) UNSIGNED NOT NULL,
  `store_id` int(10) UNSIGNED NOT NULL,
  `item_id` int(10) UNSIGNED NOT NULL,
  `quan` int(10) UNSIGNED DEFAULT NULL,
  `params` json DEFAULT NULL,
  `response` varchar(255) DEFAULT NULL,
  `updated` timestamp NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
  `created` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=COMPACT;
ALTER TABLE `tahos_provider_basket`
  ADD PRIMARY KEY (`order_id`,`store_id`,`item_id`),
  ADD KEY `item_id` (`item_id`),
  ADD KEY `store_id` (`store_id`);
ALTER TABLE `tahos_provider_basket`
  ADD CONSTRAINT `tahos_provider_basket_ibfk_1` FOREIGN KEY (`item_id`) REFERENCES `tahos_items` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  ADD CONSTRAINT `tahos_provider_basket_ibfk_2` FOREIGN KEY (`order_id`) REFERENCES `tahos_orders` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  ADD CONSTRAINT `tahos_provider_basket_ibfk_3` FOREIGN KEY (`store_id`) REFERENCES `tahos_provider_stores` (`id`) ON DELETE CASCADE ON UPDATE CASCADE;
  ALTER TABLE `tahos_provider_basket` ADD `successful` INT(1) UNSIGNED NOT NULL DEFAULT '0' AFTER `response`;
ALTER TABLE `tahos_logs` ADD `additional` TEXT NULL DEFAULT NULL AFTER `trace`;
ALTER TABLE `tahos_logs` CHANGE `additional` `additional` VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL;
ALTER TABLE `tahos_logs` ADD INDEX( `additional`);
ALTER TABLE `tahos_provider_basket` DROP `quan`, DROP `params`;



----tahos_provider_basket end

ALTER TABLE `tahos_connections` CHANGE `isDenyAccess` `isDeniedAccess` INT(1) NOT NULL DEFAULT '0';

CREATE TABLE IF NOT EXISTS `tahos_denied_addresses` (
  `ip` varchar(50) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
  PRIMARY KEY (`ip`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
CREATE TABLE IF NOT EXISTS `tahos_forbidden_pages` (
  `page` varchar(255) NOT NULL,
  PRIMARY KEY (`page`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

--------managers--------
CREATE TABLE `tahos_managers` (
  `id` int(10) UNSIGNED NOT NULL,
  `login` varchar(255) NOT NULL,
  `first_name` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci DEFAULT NULL,
  `last_name` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci DEFAULT NULL,
  `password` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
  `group_id` int(10) UNSIGNED DEFAULT NULL,
  `is_blocked` int(1) NOT NULL DEFAULT '0'
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
INSERT INTO `tahos_managers` (`id`, `login`, `first_name`, `last_name`, `password`, `group_id`, `is_blocked`) VALUES
(3, 'vadim', 'Вадим', 'Баранов', '9c6947bd95ae487c81d4e19d3ed8cd6f', 1, 0),
(6, 'skrtoha', 'Антон', 'Скричевский', 'e10adc3949ba59abbe56e057f20f883e', 2, 0);
CREATE TABLE `tahos_manager_groups` (
  `id` int(10) UNSIGNED NOT NULL,
  `title` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
  `permissions` json DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
INSERT INTO `tahos_manager_groups` (`id`, `title`, `permissions`) VALUES
(1, 'Администратор', '{\"Файлы\": \"1\", \"Валюта\": \"1\", \"Заказы\": \"1\", \"Отчеты\": \"1\", \"Прайсы\": \"1\", \"Тексты\": \"1\", \"Доставки\": \"1\", \"Менеджеры\": {\"Удаление\": \"1\", \"Изменение\": \"1\", \"Добавление\": \"1\"}, \"Сообщения\": \"1\", \"Поставщики\": {\"Удаление\": \"1\", \"Изменение\": \"1\", \"Добавление\": \"1\"}, \"Соединения\": \"1\", \"Точки выдачи\": {\"Удаление\": \"1\", \"Изменение\": \"1\", \"Добавление\": \"1\"}, \"Номенклатура\": {\"Удаление\": \"1\", \"Изменение\": \"1\", \"Добавление\": \"1\"}, \"Подкатегории\": {\"Удаление\": \"1\", \"Изменение\": \"1\", \"Добавление\": \"1\"}, \"Пользователи\": {\"Удаление\": \"1\", \"Изменение\": \"1\", \"Добавление\": \"1\"}, \"Выдачи товара\": \"1\", \"Бренды товаров\": {\"Удаление\": \"1\", \"Изменение\": \"1\", \"Добавление\": \"1\"}, \"Обновление цен\": \"1\", \"Категории товаров\": {\"Удаление\": \"1\", \"Изменение\": \"1\", \"Добавление\": \"1\"}, \"Финансовые операции\": \"1\", \"Оригинальные каталоги\": {\"Удаление\": \"1\", \"Изменение\": \"1\", \"Добавление\": \"1\"}}'),
(2, 'Менеджер по продажам', '{\"Заказы\": \"1\", \"Сообщения\": \"1\", \"Поставщики\": {\"Удаление\": \"1\", \"Изменение\": \"1\", \"Добавление\": \"1\"}, \"Точки выдачи\": {\"Удаление\": \"1\", \"Изменение\": \"1\", \"Добавление\": \"1\"}}');
ALTER TABLE `tahos_managers`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `login_2` (`login`),
  ADD KEY `group_id` (`group_id`);
ALTER TABLE `tahos_manager_groups`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `login_2` (`title`),
  ADD KEY `login` (`title`) USING BTREE;
ALTER TABLE `tahos_managers`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=7;
ALTER TABLE `tahos_manager_groups`
  MODIFY `id` int(10) UNSIGNED NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=3;
ALTER TABLE `tahos_managers`
  ADD CONSTRAINT `tahos_managers_ibfk_1` FOREIGN KEY (`group_id`) REFERENCES `tahos_manager_groups` (`id`) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE `tahos_connections` ADD `manager_id` INT UNSIGNED NULL DEFAULT NULL AFTER `user_id`;

/*
returns
 */
ALTER TABLE `tahos_provider_stores` ADD `daysForReturn` INT(2) NOT NULL DEFAULT '14' AFTER `noReturn`;
ALTER TABLE `tahos_providers` ADD `return_percent` INT(2) UNSIGNED NOT NULL DEFAULT '0' AFTER `api_title`;
ALTER TABLE `tahos_returns` ADD `is_new` INT(1) UNSIGNED NOT NULL DEFAULT '1' AFTER `status_id`;
ALTER TABLE `tahos_email_prices` CHANGE `settings` `settings` JSON NULL;
ALTER TABLE `tahos_returns` ADD `comment` VARCHAR(255) NULL DEFAULT NULL AFTER `status_id`;
ALTER TABLE `tahos_returns` ADD `amount_returned` INT UNSIGNED NULL DEFAULT NULL AFTER `comment`;
